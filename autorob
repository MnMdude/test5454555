-- Variables
local Players = game:GetService("Players")

-- Function to create an HP bar for a player
local function createHealthBar(character)
    -- Check if the player already has a health bar
    if character:FindFirstChild("HealthBarGui") then return end

    -- Create BillboardGui
    local billboardGui = Instance.new("BillboardGui")
    billboardGui.Name = "HealthBarGui"
    billboardGui.Size = UDim2.new(5, 0, 1, 0) -- Adjust size (width and height)
    billboardGui.StudsOffset = Vector3.new(2, 3, 0) -- Position it to the side of the player
    billboardGui.Adornee = character:WaitForChild("HumanoidRootPart") -- Attach to player's root part
    billboardGui.AlwaysOnTop = true -- Ensure visibility through walls
    billboardGui.Parent = character
    
    -- Create background frame for the health bar
    local bgFrame = Instance.new("Frame")
    bgFrame.Size = UDim2.new(1, 0, 0.2, 0) -- Height and width of the bar background
    bgFrame.Position = UDim2.new(0, 0, 0.5, 0)
    bgFrame.BackgroundColor3 = Color3.new(0, 0, 0) -- Black background
    bgFrame.BorderSizePixel = 0
    bgFrame.Parent = billboardGui

    -- Create health bar frame
    local healthBar = Instance.new("Frame")
    healthBar.Name = "HealthBar"
    healthBar.Size = UDim2.new(1, 0, 1, 0) -- Initial full size
    healthBar.BackgroundColor3 = Color3.new(0, 1, 0) -- Green color
    healthBar.BorderSizePixel = 0
    healthBar.Parent = bgFrame

    -- Create a function to update health
    local function updateHealth()
        local humanoid = character:WaitForChild("Humanoid")
        local healthPercentage = humanoid.Health / humanoid.MaxHealth
        healthBar.Size = UDim2.new(healthPercentage, 0, 1, 0) -- Resize based on health percentage
    end

    -- Update the health bar when the player's health changes
    local humanoid = character:WaitForChild("Humanoid")
    humanoid.HealthChanged:Connect(updateHealth)
    updateHealth() -- Initial update when the player spawns
end

-- Apply health bars to all players
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function(character)
        createHealthBar(character)
    end)
end)

-- For existing players
for _, player in pairs(Players:GetPlayers()) do
    if player.Character then
        createHealthBar(player.Character)
    end
end
